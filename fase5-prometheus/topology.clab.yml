# Fase 5: Monitorització amb Prometheus i Grafana
# ================================================
# - 2 servidors Kea DHCP4 en mode load-balancing
# - Stork server per monitorització
# - Prometheus per mètriques
# - Grafana per visualització i alertes
# - PostgreSQL per Stork
# - 3 VLANs amb relays
#
# Desplegament: ./scripts/deploy.sh prometheus

name: kea-lab-prometheus

mgmt:
  network: clab-mgmt
  ipv4-subnet: 172.20.20.0/24

topology:
  nodes:
    # ==================
    # BRIDGES
    # ==================
    br-backend:
      kind: bridge
    br-vlan10:
      kind: bridge
    br-vlan20:
      kind: bridge
    br-vlan30:
      kind: bridge

    # ==================
    # INFRAESTRUCTURA
    # ==================

    postgres:
      kind: linux
      image: postgres:16-alpine
      env:
        POSTGRES_PASSWORD: postgres
        POSTGRES_USER: postgres
        POSTGRES_DB: stork
      startup-delay: 5
      ports:
        - 5432:5432

    stork-server:
      kind: linux
      image: stork-server:latest
      env:
        STORK_DATABASE_HOST: postgres
        STORK_DATABASE_PORT: "5432"
        STORK_DATABASE_NAME: stork
        STORK_DATABASE_USER_NAME: postgres
        STORK_DATABASE_PASSWORD: postgres
        STORK_SERVER_ENABLE_METRICS: "true"
      startup-delay: 20
      ports:
        - 8080:8080

    prometheus:
      kind: linux
      image: prom/prometheus:latest
      binds:
        - ./configs/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
        - ./configs/prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      startup-delay: 25
      ports:
        - 9091:9090

    grafana:
      kind: linux
      image: grafana/grafana:latest
      env:
        GF_SECURITY_ADMIN_USER: admin
        GF_SECURITY_ADMIN_PASSWORD: admin
        GF_USERS_ALLOW_SIGN_UP: "false"
        GF_ALERTING_ENABLED: "true"
        GF_UNIFIED_ALERTING_ENABLED: "true"
      binds:
        - ./configs/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
        - ./configs/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
        - ./configs/grafana/dashboards:/etc/grafana/dashboards:ro
      startup-delay: 30
      ports:
        - 3000:3000

    # ==================
    # SERVIDORS KEA HA
    # ==================

    kea-primari-prometheus:
      kind: linux
      image: kea-stork:latest
      binds:
        - ./configs/kea-primary/kea-dhcp4.conf:/etc/kea/kea-dhcp4.conf:ro
        - ./configs/kea-primary/kea-ctrl-agent.conf:/etc/kea/kea-ctrl-agent.conf:ro
      env:
        STORK_SERVER_URL: "http://stork-server:8080"
        STORK_AGENT_HOST: "kea-primari-prometheus"
      startup-delay: 25
      exec:
        - ip addr add 10.25.115.10/24 dev eth1
        - ip addr add 10.25.115.40/24 dev eth2
        - ip route add 10.25.115.64/26 via 10.25.115.20
        - ip route add 10.25.115.128/26 via 10.25.115.21
        - ip route add 10.25.115.192/26 via 10.25.115.22

    kea-secondari-prometheus:
      kind: linux
      image: kea-stork:latest
      binds:
        - ./configs/kea-secondary/kea-dhcp4.conf:/etc/kea/kea-dhcp4.conf:ro
        - ./configs/kea-secondary/kea-ctrl-agent.conf:/etc/kea/kea-ctrl-agent.conf:ro
      env:
        STORK_SERVER_URL: "http://stork-server:8080"
        STORK_AGENT_HOST: "kea-secondari-prometheus"
      startup-delay: 25
      exec:
        - ip addr add 10.25.115.11/24 dev eth1
        - ip addr add 10.25.115.41/24 dev eth2
        - ip route add 10.25.115.64/26 via 10.25.115.20
        - ip route add 10.25.115.128/26 via 10.25.115.21
        - ip route add 10.25.115.192/26 via 10.25.115.22

    # ==================
    # RELAYS DHCP
    # ==================

    relay-vlan10:
      kind: linux
      image: kea-relay:latest
      env:
        DHCP_SERVER: "10.25.115.10 10.25.115.11"
        LISTEN_INTERFACE: "eth2"
      startup-delay: 15
      exec:
        - ip addr add 10.25.115.20/24 dev eth1
        - ip addr add 10.25.115.65/24 dev eth2

    relay-vlan20:
      kind: linux
      image: kea-relay:latest
      env:
        DHCP_SERVER: "10.25.115.10 10.25.115.11"
        LISTEN_INTERFACE: "eth2"
      startup-delay: 15
      exec:
        - ip addr add 10.25.115.21/24 dev eth1
        - ip addr add 10.25.115.129/24 dev eth2

    relay-vlan30:
      kind: linux
      image: kea-relay:latest
      env:
        DHCP_SERVER: "10.25.115.10 10.25.115.11"
        LISTEN_INTERFACE: "eth2"
      startup-delay: 15
      exec:
        - ip addr add 10.25.115.22/24 dev eth1
        - ip addr add 10.25.115.193/24 dev eth2

    # ==================
    # CLIENTS
    # ==================

    client-vlan10:
      kind: linux
      image: nicolaka/netshoot:latest

    client-vlan20:
      kind: linux
      image: nicolaka/netshoot:latest

    client-vlan30:
      kind: linux
      image: nicolaka/netshoot:latest

    # ==================
    # PROVES
    # ==================

    perfdhcp:
      kind: linux
      image: nicolaka/netshoot:latest
      cmd: sleep infinity

  links:
    # Xarxa Heartbeat HA (10.25.115.40/24 range)
    - endpoints: ["kea-primari-prometheus:eth2", "kea-secondari-prometheus:eth2"]

    # Xarxa Backend (Kea <-> Relays)
    - endpoints: ["kea-primari-prometheus:eth1", "br-backend:be-kp"]
    - endpoints: ["kea-secondari-prometheus:eth1", "br-backend:be-ks"]
    - endpoints: ["relay-vlan10:eth1", "br-backend:be-r10"]
    - endpoints: ["relay-vlan20:eth1", "br-backend:be-r20"]
    - endpoints: ["relay-vlan30:eth1", "br-backend:be-r30"]

    # VLAN 10 
    - endpoints: ["relay-vlan10:eth2", "br-vlan10:v10-relay"]
    - endpoints: ["client-vlan10:eth1", "br-vlan10:v10-cli"]
    - endpoints: ["perfdhcp:eth1", "br-vlan10:v10-perf"]

    # VLAN 20 
    - endpoints: ["relay-vlan20:eth2", "br-vlan20:v20-relay"]
    - endpoints: ["client-vlan20:eth1", "br-vlan20:v20-cli"]
    - endpoints: ["perfdhcp:eth2", "br-vlan20:v20-perf"]

    # VLAN 30 
    - endpoints: ["relay-vlan30:eth2", "br-vlan30:v30-relay"]
    - endpoints: ["client-vlan30:eth1", "br-vlan30:v30-cli"]
    - endpoints: ["perfdhcp:eth3", "br-vlan30:v30-perf"]
